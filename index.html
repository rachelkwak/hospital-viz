<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.2/mapbox-gl.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.2/mapbox-gl.css' rel='stylesheet' />
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/topojson.v2.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.2.0/mapbox-gl-geocoder.min.js'></script>
<link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.2.0/mapbox-gl-geocoder.css' type='text/css' />
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" />

<style>


#map { 
  position:relative; 
  width: 100%;
  height: 500px;
}

svg {
	position: absolute;
	width: 100%;
	height: 500px;
}

.hidden {
	display: none;
}

.show {
	display: ;
}

#usa {
	/*stroke: orange;*/
	/*fill: blue;*/
	fill-opacity: 0.5;
}


    .filter-group {
        font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        font-weight: 600;
        /*
        position: absolute;
        top: 10px;
        right: 100px;
        */
        z-index: 1;
        border-radius: 3px;
        width: 100%;
        color: #fff;
    }

    .filter-group input[type=checkbox]:first-child + label {
        border-radius: 3px 3px 0 0;
    }

    .filter-group label:last-child {
        border-radius: 0 0 3px 3px;
        border: none;
    }

    .filter-group input[type=checkbox] {
        display: none;
    }

    .filter-group input[type=checkbox] + label {
        background-color: #3386c0;
        display: block;
        cursor: pointer;
        padding: 10px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.25);
    }

    .filter-group input[type=checkbox] + label {
        background-color: #3386c0;
        text-transform: capitalize;
    }

    .filter-group input[type=checkbox] + label:hover,
    .filter-group input[type=checkbox]:checked + label {
        background-color: #4ea0da;
    }

    .filter-group input[type=checkbox]:checked + label:before {
        content: 'âœ”';
        margin-right: 5px;
    }

        .mapboxgl-popup {
        max-width: 400px;
        font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
    }

</style>


</head>

<body>

<nav class="navbar navbar-dark bg-dark justify-content-between">
  <a class="navbar-brand text-light">Hospital Vis</a>
  <div class="dropdown">
  <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    Dropdown button
  </button>
  <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
    <a class="dropdown-item" href="#">Action</a>
    <a class="dropdown-item" href="#">Another action</a>
    <a class="dropdown-item" href="#">Something else here</a>
  </div>
</div>
</nav>
<br>
<br>
<div class="container-fluid">
	<div class="row">
		<div class="col-sm-6">
			<div id="map"></div> 
			<div id='swatches'></div>
		</div>
		<div class="col-sm-3">
			<div id='filter-group' class='filter-group'></div>
		</div>
		<div class="col-sm-3">
			<div class="card">
  				<table class="table">
  <thead>
    <tr>
      <th scope="col" id="hosName">[Hosptial Name]</th>
      <th scope="col">Ratings</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th scope="row"><span id="procName">Proceedure</span> Average:</th>
      <td id="procPrice" >$-</td>
    </tr>
    <tr>
      <th scope="row">Overall Rating:</th>
      <td id="hosRating" >0</td>
    </tr>
<!--     <tr>
      <th scope="row">Effectiveness of Care:</th>
      <td id="hosCare" class="text-success">Above Average</td>
    </tr> -->
    <tr>
      <th scope="row">Safety of Care:</th>
      <td id="hosSafety" >-</td>
    </tr>
    <tr>
      <th scope="row">Patient Experience:</th>
      <td id="hosExp" >-</td>
    </tr>
  </tbody>
</table>
			</div>
		</div>
	</div>
</div> 
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiY29ybmVsbHJwYWwiLCJhIjoiY2o1bHdqZ3JuMzk2MzMybzh3dGc5Ymo5eCJ9.GZetHX1kypdxcVVSbil7jw'

var maxBounds = new mapboxgl.LngLatBounds([-167.276413, 5.499550], [-52.233040, 83.162102]);

var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v9',
    center: [-95.19670010050714, 38.04066455795754],
    zoom: 3.3381432488722704,
    maxBounds: maxBounds
});

map.addControl(new MapboxGeocoder({
    accessToken: mapboxgl.accessToken
}));

map.addControl(new mapboxgl.NavigationControl());

var zoomThreshold = 3.5;

var surgeries = [
	"001 - HEART TRANSPLANT OR IMPLANT OF HEART ASSIST SYSTEM W MCC",
	"202 - BRONCHITIS & ASTHMA W CC/MCC",
	"293 - HEART FAILURE & SHOCK W/O CC/MCC",
	"313 - CHEST PAIN",
	"536 - FRACTURES OF HIP & PELVIS W/O MCC",
	"552 - MEDICAL BACK PROBLEMS W/O MCC",
	"652 - KIDNEY TRANSPLANT",
	"765 - CESAREAN SECTION W CC/MCC",
	"864 - FEVER",
	"917 - POISONING & TOXIC EFFECTS OF DRUGS W MCC"
];

var sort = [
  "avg_covered",
  "avg_tot_pay",
  "avg_med_pay",
  "rating",
  "mortality",
  "safety",
  "experience"
];

var filterGroup = document.getElementById('filter-group');

map.on('load', function() {
	map.addSource('hospitals', {
		type: 'geojson',
		data: './medicare_processed.geojson'
	});

	surgeries.forEach(function(name) {

		var layerID = name;
		if (!map.getLayer(layerID)) {
			map.addLayer({
				id: layerID,
				type: 'circle',
				source: 'hospitals',
				minzoom: zoomThreshold,
				paint: {
					'circle-radius': {
						'base': 1.5,
						'stops': [[7, 2], [15, 100]]
					},

					"circle-color":  {
		                property: 'avg_covered',
		                // change colors
		                stops: [
		                    [0, '#F2F12D'],
		                    [5000, '#EED322'],
		                    [7500, '#E6B71E'],
		                    [10000, '#DA9C20'],
		                    [25000, '#CA8323'],
		                    [50000, '#B86B25'],
		                    [75000, '#A25626'],
		                    [100000, '#8B4225'],
		                    [250000, '#723122']
		                ] 
		             }
				},
				filter: ["==", "surgery", layerID]

			}, 'waterway-label');

			var input = document.createElement('input');
            input.type = 'checkbox';
            input.id = layerID;
            input.checked = true;
            console.log(filterGroup);
            filterGroup.appendChild(input);

            var label = document.createElement('label');
            label.setAttribute('for', layerID);
            label.textContent = layerID;
            filterGroup.appendChild(label);

            // When the checkbox changes, update the visibility of the layer.
            input.addEventListener('change', function(e) {
                map.setLayoutProperty(layerID, 'visibility',
                    e.target.checked ? 'visible' : 'none');
            });


            	  var popup = new mapboxgl.Popup({
        closeButton: false,
        closeOnClick: false
    });

	   map.on('mouseenter', layerID, function(e) {
        // Change the cursor style as a UI indicator.
        map.getCanvas().style.cursor = 'pointer';

        var coordinates = e.features[0].geometry.coordinates.slice();
        var description = e.features[0].properties.name;

        // Ensure that if the map is zoomed out such that multiple
        // copies of the feature are visible, the popup appears
        // over the copy being pointed to.
        while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
            coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
        }

        // Populate the popup and set its coordinates
        // based on the feature found.
        popuphtml = e.features[0].properties.name + "<br>" + e.features[0].properties.surgery + "<br> Avg. Price:  " + e.features[0].properties.avg_tot_pay + "<br> Rating:  " + e.features[0].properties.rating + "<br> Safety:  " + e.features[0].properties.safety + "<br> Experience:  " + e.features[0].properties.experience;
        popup.setLngLat(coordinates)
            .setHTML(popuphtml)
            .addTo(map);
    });

	map.on('click', layerID, function(e){
		console.log(e.features[0]);
		document.getElementById("hosName").innerHTML = e.features[0].properties.name;
		document.getElementById("procName").innerHTML = e.features[0].properties.surgery;
		document.getElementById("procPrice").innerHTML = e.features[0].properties.avg_tot_pay;
		document.getElementById("hosRating").innerHTML = e.features[0].properties.rating;
		document.getElementById("hosRating").className = e.features[0].properties.rating < 2.5 ? "text-danger" : e.features[0].properties.rating > 3.5  ? "text-success" : "text-warning";
		document.getElementById("hosSafety").innerHTML = e.features[0].properties.safety;
		document.getElementById("hosSafety").className = e.features[0].properties.safety === "Below the national average" ? "text-danger" : e.features[0].properties.safety === "Above the national average" ? "text-success" : "text-warning";
		document.getElementById("hosExp").innerHTML = e.features[0].properties.experience;
		document.getElementById("hosExp").className = e.features[0].properties.experience === "Below the national average" ? "text-danger" : e.features[0].properties.experience === "Above the national average" ? "text-success" : "text-warning";

	});

    map.on('mouseleave', layerID, function() {
        map.getCanvas().style.cursor = '';
        popup.remove();
    });
		}
	});

	  sort.forEach(function(g) {
	      var swatch = document.createElement('button');
	      swatch.textContent = g;
	      swatch.addEventListener('click', function() {
	      	surgeries.forEach(function(name){
	      		if (g=="avg_covered" || g=="avg_tot_pay" || g=="avg_med_pay") {
	      			map.setPaintProperty(name, 'circle-color', {
		      			property: g,
		      			stops: [
			                    [0, '#AA4225'],
			                    [5000, '#B0652A'],
			                    [7500, '#B6892F'],
			                    [10000, '#BBAE33'],
			                    [25000, '#AFC138'],
			                    [50000, '#95C73E'],
			                    [75000, '#7BCC43'],
			                    [100000, '#61D249'],
			                    [250000, '#4ED855']
			                ]

	      		});
	      		} else if (g == "rating") {
	      			map.setPaintProperty(name, 'circle-color', [
			                'match',
			                ['get', 'rating'],
			                '5', '#4ED855',
			                '4', '#7BCC43',
			                '3', '#AFC138',
			                '2', '#B6892F',
			                /* other */ '#AA4225'

				      		]);

	      		} else {
	      			map.setPaintProperty(name, 'circle-color', [
			                'match',
			                ['get', g],
			                'Below the national average', 'red',
			                'Same as the national average', 'blue',
			                'Above the national average', 'green',
			                /* other */ '#ccc'

				      		]);
	      		}

	      	});
	          
	      });
	      swatches.appendChild(swatch);
	  });



});

map.on('load', function() {
	map.addSource('stateData', {
	type: 'geojson',
	data: './stateData.geojson'
});

    map.addLayer({
        'id': 'state-cov',
        'source': 'stateData',
        'type': 'fill',
        'maxzoom': zoomThreshold,
        'paint': {
            'fill-color': {
                property: 'avg_covered',
                // change colors
                stops: [
                    [0, '#AA4225'],
			                    [5000, '#B0652A'],
			                    [7500, '#B6892F'],
			                    [10000, '#BBAE33'],
			                    [25000, '#AFC138'],
			                    [50000, '#95C73E'],
			                    [75000, '#7BCC43'],
			                    [100000, '#61D249'],
			                    [250000, '#4ED855']
                ] 
            },
            'fill-opacity': 0.75
        }
    }, 'waterway-label');
});

// map.on('load', function() {
// 	map.addSource('hospitals', {
// 	type: 'geojson',
// 	data: './hospitals_processed.geojson'
// });

// 	map.addLayer({
// 	  id: 'points',
// 	  interactive: true,
// 	  type: 'circle',
// 	  source: 'hospitals',
// 	  minzoom: zoomThreshold,
// 	  paint: {
// 	    'circle-radius': {
// 	      	'base': 1.5,
//             'stops': [[12, 2], [22, 100]]
// 	    	},

// 	    "circle-color": 'red',
// 	  	}

// 	}, 'waterway-label');
// });









// var container = map.getCanvasContainer();
// var svg_map = d3.select(container).append("svg");
// var svg_data = d3.select(container).append("svg");

// var transform = d3.geoTransform({
//     point: projectPoint
// });
// var path = d3.geoPath().projection(transform);


// d3.json("us.json", function(err, data) {
// 	d3.json("state_cost.json", function(err, state_data) {
// 		d3.json("hospital.json", function(err, hospital) {
			
// 			hospital.forEach(function(d) {
// 				if (d.long&& d.lat){
// 					d.coord = new mapboxgl.LngLat(d.long, d.lat);
// 				}
//             });
// 			var color = d3.scaleLinear()
// 								.domain([18000, 97700])  
// 								.range(["white", "blue"]); 

// 		    var featureElement = svg_map.selectAll("path")
// 		        .data(topojson.feature(data, data.objects.states).features)
// 		        .enter()
// 		        .append("path")
// 		        .attr("d", path)
// 		        .attr("id", "usa")
// 		        .style("fill", function(d) {return color(state_data[d.properties.name]); });

// 		    var circles = svg_data.attr("id", "hospital").selectAll("circle").data(hospital);

// 		    map.on("viewreset", update)
// 		    map.on("movestart", function() {
// 		        svg_map.classed("hidden", true);
// 		        svg_data.classed("hidden", true);
// 		    });
// 		    map.on("moveend", function() {
// 		        update()
		        
// 		        if (map.getZoom() < 7) {
// 		            svg_map.classed("hidden", false);
// 		            svg_data.classed("hidden", true);
// 		        } else {
// 		        	svg_data.classed("hidden", false);
// 		        }
// 		    })

// 		    function update() {
// 		        featureElement.attr("d", path);

// 		        if (map.getZoom() >= 7) {
// 			        circles.enter().selectAll('circle').remove();

// 				    circles.enter()
// 		                    .append("circle")
// 		                    .attr("cx", function(d) {
// 		                        if (d.coord) {
// 		                        	var c = map.project(d.coord);
// 		                            return c['x'];
// 		                        }
// 		                    })
// 		                    .attr("cy", function(d) {
// 		                        if (d.coord) {
// 		                        	var c = map.project(d.coord);
// 		                            return c['y'];
// 		                        }
// 		                    })
// 		                    .attr("r", 4)
// 		                    .attr('fill-opacity', 0.4)
// 		                    .style("fill", "blue")
// 		        }

// 		    }

		    
// 		});
//     });
// });

// function projectPoint(lon, lat) {
//     var point = map.project(new mapboxgl.LngLat(lon, lat));
//     this.stream.point(point.x, point.y);
// }

</script>

</body>
</html>