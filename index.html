<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.2/mapbox-gl.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.2/mapbox-gl.css' rel='stylesheet' />
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/topojson.v2.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.2.0/mapbox-gl-geocoder.min.js'></script>
<link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.2.0/mapbox-gl-geocoder.css' type='text/css' />
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" />

<style>


#map { 
  position:relative; 
  width: 900px;
  height: 500px;
}



    .filter-group {
        font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        font-weight: 600;
        
        position: absolute;
        top: 10px;
        right: 100px;
        
        z-index: 1;
        border-radius: 3px;
        width: 400px;
        color: #fff;
    }

    .filter-group input[type=checkbox]:first-child + label {
        border-radius: 3px 3px 0 0;
    }

    .filter-group label:last-child {
        border-radius: 0 0 3px 3px;
        border: none;
    }

    .filter-group input[type=checkbox] {
        display: none;
    }

    .filter-group input[type=checkbox] + label {
        background-color: #3386c0;
        display: block;
        cursor: pointer;
        padding: 10px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.25);
    }

    .filter-group input[type=checkbox] + label {
        background-color: #3386c0;
        text-transform: capitalize;
    }

    .filter-group input[type=checkbox] + label:hover,
    .filter-group input[type=checkbox]:checked + label {
        background-color: #4ea0da;
    }

    .filter-group input[type=checkbox]:checked + label:before {
        content: 'âœ”';
        margin-right: 5px;
    }

        .mapboxgl-popup {
        max-width: 400px;
        font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
    }

    .legend {
    background-color: #fff;
    border-radius: 3px;
    bottom: 320px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.10);
    font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
    padding: 10px;
    position: absolute;
    right: 550px;
    z-index: 1;
}

.legend h6 {
    margin: 0 0 10px;
}

.legend div span {
    border-radius: 50%;
    display: inline-block;
    height: 10px;
    margin-right: 5px;
    width: 10px;
}

</style>


</head>


<body>
<div id="map"></div> 
<div id='state-legend' class='legend'>
    <h6>Avg Cost</h6>
    <div><span style='background-color: #081d58'></span>97,700</div>
    <div><span style='background-color: #253494'></span>77,810</div>
    <div><span style='background-color: #225ea8'></span>67,910</div>
    <div><span style='background-color: #1d91c0'></span>58,010</div>
    <div><span style='background-color: #41b6c4'></span>48,110</div>
    <div><span style='background-color: #7fcdbb'></span>38,210</div>
    <div><span style='background-color: #c7e9b4'></span>28,310</div>
    <div><span style='background-color: #edf8b1'></span>18,410</div>
    <div><span style='background-color: #ffffd9'></span>8,510</div>
</div>

<div id='avg-legend' class='legend' style='display: none;'>
    <h6>Cost</h6>
    <div><span style='background-color: #081d58'></span>200,600</div>
    <div><span style='background-color: #253494'></span>76,800</div>
    <div><span style='background-color: #225ea8'></span>38,400</div>
    <div><span style='background-color: #1d91c0'></span>19,200</div>
    <div><span style='background-color: #41b6c4'></span>9,600</div>
    <div><span style='background-color: #7fcdbb'></span>4,800</div>
    <div><span style='background-color: #c7e9b4'></span>2,400</div>
    <div><span style='background-color: #edf8b1'></span>1,200</div>
    <div><span style='background-color: #ffffd9'></span>600</div>
</div>
<div id='rating-legend' class='legend' style='display: none;'>
    <h6>Rating</h6>
    <div><span style='background-color: #2c7bb6'></span>5</div>
    <div><span style='background-color: #abd9e9'></span>4</div>
    <div><span style='background-color: #ffffbf'></span>3</div>
    <div><span style='background-color: #fdae61'></span>2</div>
    <div><span style='background-color: #d7191c'></span>Other</div>
</div>

<div id='feature-legend' class='legend' style='display: none;'>
    <h6>Features</h6>
    <div><span style='background-color: #91bfdb'></span>Above Avg</div>
    <div><span style='background-color: #ffffbf'></span>Same</div>
    <div><span style='background-color: #fc8d59'></span>Below Avg</div>
    <div><span style='background-color: #ccc'></span>Other</div>
</div>
<nav id='filter-group' class='filter-group'></nav>
<div id='buttons'></div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiY29ybmVsbHJwYWwiLCJhIjoiY2o1bHdqZ3JuMzk2MzMybzh3dGc5Ymo5eCJ9.GZetHX1kypdxcVVSbil7jw'

var maxBounds = new mapboxgl.LngLatBounds([-167.276413, 5.499550], [-52.233040, 83.162102]);

var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v9',
    center: [-95.19670010050714, 38.04066455795754],
    zoom: 3.3381432488722704,
    maxBounds: maxBounds
});

map.addControl(new MapboxGeocoder({
    accessToken: mapboxgl.accessToken
}));

map.addControl(new mapboxgl.NavigationControl());

var zoomThreshold = 3.4;

var surgeries = [
	"001 - HEART TRANSPLANT OR IMPLANT OF HEART ASSIST SYSTEM W MCC",
	"202 - BRONCHITIS & ASTHMA W CC/MCC",
	"293 - HEART FAILURE & SHOCK W/O CC/MCC",
	"313 - CHEST PAIN",
	"536 - FRACTURES OF HIP & PELVIS W/O MCC",
	"552 - MEDICAL BACK PROBLEMS W/O MCC",
	"652 - KIDNEY TRANSPLANT",
	"765 - CESAREAN SECTION W CC/MCC",
	"864 - FEVER",
	"917 - POISONING & TOXIC EFFECTS OF DRUGS W MCC"
];

var sort = [
  "avg_covered",
  "avg_tot_pay",
  "avg_med_pay",
  "rating",
  "mortality",
  "safety",
  "experience"
];

var filterGroup = document.getElementById('filter-group');

map.on('load', function() {
	map.addSource('hospitals', {
		type: 'geojson',
		data: './medicare_processed.geojson'
	});

	surgeries.forEach(function(name) {

		var layerID = name;
		if (!map.getLayer(layerID)) {
			map.addLayer({
				id: layerID,
				type: 'circle',
				source: 'hospitals',
				minzoom: zoomThreshold,
				paint: {
					'circle-radius': {
						'base': 1.5,
						'stops': [[7, 2], [15, 100]]
					},

					"circle-color":  {
		                property: 'avg_covered',
		                // change colors
		                stops: [
			                    [650, '#ffffd9'],
			                    [1000, '#edf8b1'],
			                    [1800, '#c7e9b4'],
			                    [4000, '#7fcdbb'],
			                    [12000, '#41b6c4'],
			                    [30000, '#1d91c0'],
			                    [60000, '#225ea8'],
			                    [120000, '#253494'],
			                    [240000, '#081d58']
		                ] 
		             }
				},
				filter: ["==", "surgery", layerID]

			}, 'waterway-label');

			var input = document.createElement('input');
            input.type = 'checkbox';
            input.id = layerID;
            input.checked = true;
            console.log(filterGroup);
            filterGroup.appendChild(input);

            var label = document.createElement('label');
            label.setAttribute('for', layerID);
            label.textContent = layerID;
            filterGroup.appendChild(label);

            // When the checkbox changes, update the visibility of the layer.
            input.addEventListener('change', function(e) {
                map.setLayoutProperty(layerID, 'visibility',
                    e.target.checked ? 'visible' : 'none');
            });


            	  var popup = new mapboxgl.Popup({
        closeButton: false,
        closeOnClick: false
    });

	   map.on('mouseenter', layerID, function(e) {
        // Change the cursor style as a UI indicator.
        map.getCanvas().style.cursor = 'pointer';

        var coordinates = e.features[0].geometry.coordinates.slice();
        var description = e.features[0].properties.name;

        // Ensure that if the map is zoomed out such that multiple
        // copies of the feature are visible, the popup appears
        // over the copy being pointed to.
        while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
            coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
        }

        // Populate the popup and set its coordinates
        // based on the feature found.
        popuphtml = e.features[0].properties.name + "<br> Rating:  " + e.features[0].properties.rating + "<br> Safety:  " + e.features[0].properties.safety + "<br> Experience:  " + e.features[0].properties.experience;
        popup.setLngLat(coordinates)
            .setHTML(popuphtml)
            .addTo(map);
    });


    map.on('mouseleave', layerID, function() {
        map.getCanvas().style.cursor = '';
        popup.remove();
    });
		}
	});

	var stateLegendEl = document.getElementById('state-legend');
	var avgLegendEl = document.getElementById('avg-legend');
	var ratingLegendEl = document.getElementById('rating-legend');
	var featureLegendEl = document.getElementById('feature-legend');

	  sort.forEach(function(g) {
	      var b = document.createElement('button');
	      b.type = 'button';
	      b.setAttribute("class", "btn btn-outline-primary");
	      b.textContent = g;
	      b.addEventListener('click', function() {
	      	surgeries.forEach(function(name){
	      		if (g=="avg_covered" || g=="avg_tot_pay" || g=="avg_med_pay") {
	      			map.setPaintProperty(name, 'circle-color', {
		      			property: g,
		      			stops: [
			                    [600, '#ffffd9'],
			                    [1200, '#edf8b1'],
			                    [2400, '#c7e9b4'],
			                    [4800, '#7fcdbb'],
			                    [9600, '#41b6c4'],
			                    [19200, '#1d91c0'],
			                    [38400, '#225ea8'],
			                    [76800, '#253494'],
			                    [200600, '#081d58']
			                ]
	      		});
	      			stateLegendEl.style.display = 'none';
	      			avgLegendEl.style.display = 'block';
	      			ratingLegendEl.style.display = 'none';
        			featureLegendEl.style.display = 'none';
	      		} else if (g == "rating") {
	      			map.setPaintProperty(name, 'circle-color', [
			                'match',
			                ['get', 'rating'],
			                '5', '#2c7bb6',
			                '4', '#abd9e9',
			                '3', '#ffffbf',
			                '2', '#fdae61',
			                /* other */ '#d7191c'

				      		]);
	      			stateLegendEl.style.display = 'none';
	      			avgLegendEl.style.display = 'none';
	      			ratingLegendEl.style.display = 'block';
        			featureLegendEl.style.display = 'none';

	      		} else {
	      			map.setPaintProperty(name, 'circle-color', [
			                'match',
			                ['get', g],
			                'Below the national average', '#fc8d59',
			                'Same as the national average', '#ffffbf',
			                'Above the national average', '#91bfdb',
			                /* other */ '#ccc'

				      		]);
	      			stateLegendEl.style.display = 'none';
	      			avgLegendEl.style.display = 'none';
	      			ratingLegendEl.style.display = 'none';
        			featureLegendEl.style.display = 'block';
	      		}

	      	});
	          
	      });
	      buttons.appendChild(b);
	  });

	  map.on('zoom', function() {
	    if (map.getZoom() > zoomThreshold) {
	      			stateLegendEl.style.display = 'none';
	    } else {
	      			stateLegendEl.style.display = 'block';
	      			avgLegendEl.style.display = 'none';
	      			ratingLegendEl.style.display = 'none';
        			featureLegendEl.style.display = 'none';
	    }
	});

});

map.on('load', function() {
	map.addSource('stateData', {
	type: 'geojson',
	data: './stateData.geojson'
});

    map.addLayer({
        'id': 'state-cov',
        'source': 'stateData',
        'type': 'fill',
        'maxzoom': zoomThreshold,
        'paint': {
            'fill-color': {
                property: 'avg_covered',
                // change colors
                stops: [
			                    [8510, '#ffffd9'],
			                    [18410, '#edf8b1'],
			                    [28310, '#c7e9b4'],
			                    [38210, '#7fcdbb'],
			                    [48110, '#41b6c4'],
			                    [58010, '#1d91c0'],
			                    [67910, '#225ea8'],
			                    [77810, '#253494'],
			                    [97700, '#081d58']
                ] 
            },
            'fill-opacity': 0.75
        }
    }, 'waterway-label');
});

// map.on('load', function() {
// 	map.addSource('hospitals', {
// 	type: 'geojson',
// 	data: './hospitals_processed.geojson'
// });

// 	map.addLayer({
// 	  id: 'points',
// 	  interactive: true,
// 	  type: 'circle',
// 	  source: 'hospitals',
// 	  minzoom: zoomThreshold,
// 	  paint: {
// 	    'circle-radius': {
// 	      	'base': 1.5,
//             'stops': [[12, 2], [22, 100]]
// 	    	},

// 	    "circle-color": 'red',
// 	  	}

// 	}, 'waterway-label');
// });









// var container = map.getCanvasContainer();
// var svg_map = d3.select(container).append("svg");
// var svg_data = d3.select(container).append("svg");

// var transform = d3.geoTransform({
//     point: projectPoint
// });
// var path = d3.geoPath().projection(transform);


// d3.json("us.json", function(err, data) {
// 	d3.json("state_cost.json", function(err, state_data) {
// 		d3.json("hospital.json", function(err, hospital) {
			
// 			hospital.forEach(function(d) {
// 				if (d.long&& d.lat){
// 					d.coord = new mapboxgl.LngLat(d.long, d.lat);
// 				}
//             });
// 			var color = d3.scaleLinear()
// 								.domain([18000, 97700])  
// 								.range(["white", "blue"]); 

// 		    var featureElement = svg_map.selectAll("path")
// 		        .data(topojson.feature(data, data.objects.states).features)
// 		        .enter()
// 		        .append("path")
// 		        .attr("d", path)
// 		        .attr("id", "usa")
// 		        .style("fill", function(d) {return color(state_data[d.properties.name]); });

// 		    var circles = svg_data.attr("id", "hospital").selectAll("circle").data(hospital);

// 		    map.on("viewreset", update)
// 		    map.on("movestart", function() {
// 		        svg_map.classed("hidden", true);
// 		        svg_data.classed("hidden", true);
// 		    });
// 		    map.on("moveend", function() {
// 		        update()
		        
// 		        if (map.getZoom() < 7) {
// 		            svg_map.classed("hidden", false);
// 		            svg_data.classed("hidden", true);
// 		        } else {
// 		        	svg_data.classed("hidden", false);
// 		        }
// 		    })

// 		    function update() {
// 		        featureElement.attr("d", path);

// 		        if (map.getZoom() >= 7) {
// 			        circles.enter().selectAll('circle').remove();

// 				    circles.enter()
// 		                    .append("circle")
// 		                    .attr("cx", function(d) {
// 		                        if (d.coord) {
// 		                        	var c = map.project(d.coord);
// 		                            return c['x'];
// 		                        }
// 		                    })
// 		                    .attr("cy", function(d) {
// 		                        if (d.coord) {
// 		                        	var c = map.project(d.coord);
// 		                            return c['y'];
// 		                        }
// 		                    })
// 		                    .attr("r", 4)
// 		                    .attr('fill-opacity', 0.4)
// 		                    .style("fill", "blue")
// 		        }

// 		    }

		    
// 		});
//     });
// });

// function projectPoint(lon, lat) {
//     var point = map.project(new mapboxgl.LngLat(lon, lat));
//     this.stream.point(point.x, point.y);
// }

</script>

</body>
</html>